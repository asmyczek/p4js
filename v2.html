<html>
  <head>
    <script src="./src/p4.js"></script>
  </head>
<body>
	<script>

      var trim = function(str) { return str.replace(/^\s+|\s+$/g, ''); };

/*
      $P().do().many($P().noneOf(",\n")).join('', trim).register("csv_value");
      //$P().addParser(function() { return this.do().csv_value().csv_next_values().return(); }).register("csv_values");
      $P().choice(
            $P().do().char(",").csv_values().reduce(function(vs) { return vs[1]; }), 
            $P().return([])).register("csv_next_values");
	  P4JS.lib.csv_values = function(vs) {
		return this.do().csv_value().csv_next_values().join();
	  };
      $P().do().csv_values().eol().reduce(function(vs) { return vs[0]; }).register("csv_line");
      $P().many($P().csv_line()).register("csv");
      var p = $P().csv();
*/

/*
var _value = _do(_many(_noneOf(",\n"))).doReturn(joinArray("", trim));
var _values = function(state) { return _do(_value, _next_values).doReturn(cons)(state); };
var _next_values = _choice(
	  _do(_char(","), _values).doReturn(function(_,vs) { return vs; }),
	  _return([]));
var _line = _do(_values, _eol).doReturn(function(vs, _) { return vs; });
var _csv = _many(_line);
*/
		$P().do().many($P().noneOf(",\n")).join('', trim).register("csv_value");
		P4JS.lib.csv_values = function() { 
			return this.pushParser(function(vs) {
				this.runParser($P().do().csv_value().csv_next_values().reduce(), vs);
			}); };
		$P().choice(
			$P().do().char(",").csv_values().reduce(function(vs) { return vs[1]; }), 
			$P().return([])).register("csv_next_values");
		$P().do().csv_values().eol().reduce(function(vs) { return vs[0]; }).register("csv_line");
		$P().many($P().csv_line()).register("csv");

//		try {
			var p = $P().csv();
			var r = p.parse('a1,a2,a3\nb1,b2,b3\n');
			alert(r);
//		} catch(e) {
//			alert("Exception: " + ((e.print)? e.print() : e));
//		}

	</script>
</body>
</html>

